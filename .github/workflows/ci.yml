name: CI

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

jobs:
    backend:
        name: Backend — Build & Test
        runs-on: ubuntu-latest
        permissions:
            contents: read

        services:
            postgres:
                image: postgres:16-alpine
                env:
                    POSTGRES_DB: gamelibrary_test
                    POSTGRES_USER: dev
                    POSTGRES_PASSWORD: devpassword
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 5s
                    --health-timeout 5s
                    --health-retries 10

        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Setup Java 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"
                  cache: maven

            - name: Build & Test
              working-directory: backend
              run: mvn verify
              env:
                  SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/gamelibrary_test
                  SPRING_DATASOURCE_USERNAME: dev
                  SPRING_DATASOURCE_PASSWORD: devpassword

            - name: Upload coverage report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: backend-coverage
                  path: backend/target/site/jacoco/

    frontend:
        name: Frontend — Lint & Test
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Setup Node LTS
              uses: actions/setup-node@v4
              with:
                  node-version: "lts/*"
                  cache: npm
                  cache-dependency-path: frontend/package-lock.json

            - name: Install dependencies
              working-directory: frontend
              run: npm ci

            - name: Lint
              working-directory: frontend
              run: npm run lint

            - name: Test
              working-directory: frontend
              run: npm test -- --watch=false --browsers=ChromeHeadless

            - name: Upload coverage report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: frontend-coverage
                  path: frontend/coverage/
